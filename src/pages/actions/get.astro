---
import prisma from '../../lib/db'; // Sesuaikan dengan lokasi Prisma client Anda
import jwt, { type JwtPayload } from 'jsonwebtoken';

export async function getUserFromToken(token : string) {
  try {
    // Log the Astro object to debug
    const jwtKey = import.meta.env.AUTH_SECRET;
    if (!jwtKey) {
      throw new Error('JWT key not found in environment variables');
    }

    // Verify the token
    const decoded = jwt.verify(token, jwtKey);
    if (typeof decoded === 'string') {
      throw new Error('Invalid token payload');
    }

    // Get the userId from the decoded token
    const userId = (decoded as JwtPayload).userId as string;
    if (!userId) {
      throw new Error('User ID not found in token');
    }

    // Fetch the user from the database
    const user = await prisma.user.findUnique({
      where: {
        id: userId,
      },
      include: {
        accounts: true,
        sessions: true,
        likes: true,
      },
    });

    if (!user) {
      throw new Error('User not found');
    }

    return user;
  } catch (error) {
    console.error('Error getting user from token:', error);
    throw error; // Re-throw the error to handle it where this function is called
  }
}
// export async function Getdata ()  {
//     try {
//         const data = await prisma.blog.findMany({
//             orderBy : {
//                 createdAt : 'desc'
//             }
//         })
//         return data
//     }catch{
//         throw new Error('Internal Server Error')
//     }
// }


export async function GetDataTrending (){
    const api_key = import.meta.env.API_KEY
    try {
        const data = await fetch(`https://newsapi.org/v2/everything?q=b&from=2024-06-24&to=2024-06-24&sortBy=popularity&apiKey=${api_key}`)
        const response = await data.json()
        return response
    }catch {
        throw new Error('Internal Server Error')
    }
}
export async function GetDataByCountry (){
    const api_key = import.meta.env.API_KEY
    try {
        const data = await fetch(`https://newsapi.org/v2/top-headlines?country=us&apiKey=${api_key}`)
        const response = await data.json()
        return response
    }catch {
        throw new Error('Internal Server Error')
    }
}

export async function getByCategory() {
    const api_key = import.meta.env.API_KEY
    try {
        const data = await fetch(`https://newsapi.org/v2/top-headlines?sources=bbc-news&apiKey=${api_key}`)
        const response = await data.json()
        return response
    }catch {
        throw new Error('Internal Server Error')

    }
}

export async function getTrending() {
    const api_key = import.meta.env.API_KEY
    try {
        const data = await fetch(`https://newsapi.org/v2/everything?q=apple&from=2024-06-24&to=2024-06-24&sortBy=popularity&apiKey=${api_key}`)
        const response = await data.json()
        return response
    }catch {
        throw new Error('Internal Server Error')

    }
}


---
